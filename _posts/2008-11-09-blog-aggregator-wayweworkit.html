--- 
name: blog-aggregator-wayweworkit
layout: post
title: I built a blog aggregator - waywework.it
time: 2008-11-09 10:33:00.005000 -05:00
---

<p>
  I've been spending some time recently putting together a blog aggregator site for some of the folks I work with. Its now up and running at <a href="http://waywework.it">http://waywework.it</a>. I hope this will be an interesting place to share our public community and as one of my colleagues said "this keeps my Google Reader much neater".<br>
  <br>
  Today I'd like to talk about the code running this site which is posted and available on github at <a href="http://github.com/alexrothenberg/waywework">http://github.com/alexrothenberg/waywework</a>.<br>
  <br>
  I started thinking I would use an existing aggregator site and just apply my skin but when I did a quick search on github I most of the hard work existed in atom and rss gems and plugins and I wanted to take advantage of the just released Rails 2.2 so I decided to build my own. This turned out to be not too much work. Today I'd like to talk about how I put this together.<br>
  <br>
  First I created my project with some scaffolding for feeds which would have_many posts<br>
</p>
<pre>
<br>class Feed &lt; ActiveRecord::Base<br>  has_many :posts, :dependent =&gt; :delete_all<br>end<br><br>class Post &lt; ActiveRecord::Base<br>  belongs_to :feed<br>end<br>
</pre>
<p>
  <br>
  <br>
  I soon found the <a href="http://split-s.blogspot.com/2006/04/atom-10-parser-for-ruby.html">atom gem</a> and <a href="http://www.rubyrss.com/">rss parser</a> built into ruby. Using them was a piece of cake as all I had to do was create a method to call each one in my Feed model<br>
</p>
<pre>
<br>class Feed &lt; ActiveRecord::Base<br>  def get_posts_from_atom atom_xml<br>    feed = Atom::Feed.new(atom_xml)<br>    feed.entries.each { |entry|<br>      link = entry.links.detect {|l| l.rel == 'alternate'}<br>      create_post(:contents=&gt;entry.content.value, :url=&gt;link.href, :title=&gt;entry.title, :published=&gt;entry.published.to_s(:db), :updated=&gt;entry.updated.to_s(:db))<br>    }<br>    return !feed.entries.blank?<br>  end  <br>  <br>  def get_posts_from_rss rss_xml<br>    rss = RSS::Parser.parse(rss_xml, false)<br>    rss.items.each { |entry|<br>      create_post(:contents=&gt;entry.description, :url=&gt;entry.link, :title=&gt;entry.title, :published=&gt;entry.date.to_formatted_s(:db), :updated=&gt;entry.date.to_formatted_s(:db))<br>    }<br>    return !rss.items.blank?<br>  end<br>end<br>
</pre>
<p>
  <br>
  <br>
  Of course I had to create the glue wrapping it all together. A rake task to be call on a schedule<br>
</p>
<pre>
<br>namespace :feeds do<br>  desc "Load the feeds"<br>  task :populate =&gt; :environment do<br>    feeds = Feed.all<br>    feeds.each do |feed|<br>      feed.get_latest<br>    end<br>  end<br>end<br>
</pre>
<p>
  <br>
  <br>
  and the logic to load the feed, parse it and update the posts.<br>
</p>
<pre>
<br>class Feed &lt; ActiveRecord::Base<br>  def get_latest<br>    puts "getting feed for #{name}"<br>    xml = get_feed<br>    got_atom_posts = get_posts_from_atom xml<br>    get_posts_from_rss xml unless got_atom_posts<br>  end<br><br>  def get_feed<br>    uri = URI.parse(feed_url)<br>    uri.read<br>  end<br>  <br>  def create_post params<br>    params.merge!(:feed_id=&gt;id) <br>    existing_post = Post.find_by_url(params[:url])<br>    if existing_post<br>      existing_post.update_attributes(params)<br>    else<br>      Post.create(params) <br>    end<br>  end<br>end<br>
</pre>
<p>
  <br>
  <br>
  The next step was to publish an atom feed of my site. Again there was a plugin <a href="http://dev.rubyonrails.org/browser/plugins/atom_feed_helper">atom_feed_helper</a>waiting to help me. I installed the plugin and created a view builder<br>
</p>
<pre>
<br>atom_feed(:url =&gt; atom_feed_url) do |feed|<br>  feed.title("WayWeWork")<br>  feed.updated(@posts.first.published)<br><br>  for post in @posts<br>    feed.entry(post, :url=&gt;post.url, :published=&gt;post.published, :updated=&gt;post.updated) do |entry|<br>      entry.title("#{post.feed.author}: #{post.title}")<br>      entry.content(post.contents, :type =&gt; 'html')<br>    end<br>  end<br>end<br>
</pre>
<p>
  <br>
  This was all so easy I had hardly done anything other than glue these plugins together. Now I finished up with a few bells and whistles.<br>
  <br>
  I added a who's talking and archive by date section to my homepage that I called from my controller like this<br>
</p>
<pre>
<br>class PostsController &lt; ApplicationController<br>  @active_feeds = Feed.by_author<br>  @activity_by_date = Post.activity_by_date<br>end<br>
</pre>
<p>
  <br>
  <br>
  I added security to restrict who can administer feeds<br>
</p>
<pre>
<br>class FeedsController &lt; ApplicationController<br>  before_filter :authenticate<br><br>protected<br>  def authenticate<br>     authenticate_or_request_with_http_basic do | user_name, password|<br>       username = YAML::load_file(File.join(RAILS_ROOT, %w[config password.yml]))['username']<br>       pwd = YAML::load_file(File.join(RAILS_ROOT, %w[config password.yml]))['password']<br>      user_name == username &amp;&amp; password == pwd<br>    end<br>  end<br>end<br>
</pre>
<p>
  <br>
  <br>
  For the UI I am somewhat graphically challenged so got some help. For this github was very cool as I could add <a href="http://github.com/lessallan">lessallan</a> as a collaborator and he could check in his changes so they just appeared!<br>
  <br>
  Finally a little work with capistrano (mostly just creating a <a href="http://github.com/alexrothenberg/waywework/tree/master/Capfile">Capfile</a>) and I could deploy!<br>
  <br>
  Overall I spent a few days and now have a site that does exactly what I want. Where most of the code I wrote is specific to my site and the general purpose plumbing was downloaded. I'm very pleased with the availability of plugins and gems and how easy it was to collaborate using github!<br>
  <br>
  Now I just hope others find the site interesting to use!
</p>
